# -*- python -*-
# ex: set syntax=python:

from buildbot.plugins import *
from twisted.python import log
from password import *
from builderinfo import *

bb_slave_port = 9989
bb_try_port = 8033
bb_web_port = 8010
bb_master = "build.zfsonlinux.org:9989"
bb_url = "https://raw.githubusercontent.com/zfsonlinux/zfs-buildbot/master/scripts/"
zol_url = "http://zfsonlinux.org"
web_url = "http://build.zfsonlinux.org/"
spl_repo = "https://github.com/zfsonlinux/spl.git"
zfs_repo = "https://github.com/zfsonlinux/zfs.git"
linux_repo = "https://github.com/torvalds/linux.git"
zfs_path = "/usr/libexec/zfs:/usr/share/zfs:/usr/lib/rpm/zfs:/usr/lib/zfs"
bin_path = "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

all_repositories = {
    "https://github.com/torvalds/linux" : 'linux',
    "https://github.com/zfsonlinux/spl" : 'spl',
    "https://github.com/zfsonlinux/zfs" : 'zfs',
    "https://github.com/torvalds/linux.git" : 'linux',
    "https://github.com/zfsonlinux/spl.git" : 'spl',
    "https://github.com/zfsonlinux/zfs.git" : 'zfs',
}

c = BuildmasterConfig = {}

####### FACTORIES

from buildbot.steps.source.git import Git
from buildbot.steps.shell import ShellCommand
from buildbot.status.results import SUCCESS
from buildbot.status.results import FAILURE
from buildbot.status.results import WARNINGS
from buildbot.status.results import SKIPPED

#
# Perform a local in-tree build using the default options.  This is
# solely for the purpose of ensuring we don't break the build.
#

def do_step_build(step, name):
    props = step.build.getProperties()
    if props.hasProperty(name) and props[name] == "yes":
        return True
    else:
        return False

def do_step_build_linux(step):
    return do_step_build(step, 'buildlinux')

def do_step_build_spl(step):
    return do_step_build(step, 'buildspl')

def do_step_build_zfs(step):
    return do_step_build(step, 'buildzfs')

build_factory = util.BuildFactory()

build_factory.addStep(ShellCommand(
    env={'PATH' : bin_path},
    command=["runurl", bb_url + "bb-dependencies.sh"],
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    haltOnFailure=True, logEnviron=False,
    description=["installing dependencies"],
    descriptionDone=["installed dependencies"]))

build_factory.addStep(Git(repourl=linux_repo, workdir="build/linux",
    mode="full", method="clobber", shallow=True, codebase="linux",
    logEnviron=False, getDescription=True,
    description=["cloning"], descriptionDone=["cloned"],
    doStepIf = do_step_build_linux,
    hideStepIf=lambda results, s: results==SKIPPED))
build_factory.addStep(Git(repourl=spl_repo, workdir="build/spl",
    mode="full", method="clobber", codebase="spl",
    logEnviron=False, getDescription=True,
    description=["cloning"], descriptionDone=["cloned"]))
build_factory.addStep(Git(repourl=zfs_repo, workdir="build/zfs",
    mode="full", method="clobber", codebase="zfs",
    logEnviron=False, getDescription=True,
    description=["cloning"], descriptionDone=["cloned"]))

build_factory.addStep(ShellCommand(
    workdir="build/linux", env={'PATH' : bin_path,
        'LINUX_BUILTIN' : util.Interpolate('%(prop:builtin:-no)s') },
    command=["runurl", bb_url + "bb-build-linux.sh"],
    haltOnFailure=True, logEnviron=False,
    logfiles={"configure"  : { "filename" : "configure.log", "follow" : True },
              ".config"    : { "filename" : ".config",       "follow" : False},
              "make"       : { "filename" : "make.log",      "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["building linux"], descriptionDone=["built linux"],
    doStepIf = do_step_build_linux,
    hideStepIf=lambda results, s: results==SKIPPED))
build_factory.addStep(ShellCommand(
    workdir="build/spl", env={'PATH' : bin_path,
        'LINUX_CUSTOM' : util.Interpolate('%(prop:buildlinux:-no)s') },
    command=["runurl", bb_url + "bb-build-zfs.sh"],
    haltOnFailure=True, logEnviron=False,
    logfiles={"configure"  : { "filename" : "configure.log", "follow" : True },
              "config.log" : { "filename" : "config.log",    "follow" : True },
              "make"       : { "filename" : "make.log",      "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["building spl"], descriptionDone=["built spl"],
    doStepIf = do_step_build_spl,
    hideStepIf=lambda results, s: results==SKIPPED))
build_factory.addStep(ShellCommand(
    workdir="build/zfs", env={'PATH' : bin_path,
        'LINUX_CUSTOM' : util.Interpolate('%(prop:buildlinux:-no)s') },
    command=["runurl", bb_url + "bb-build-zfs.sh"],
    haltOnFailure=True, logEnviron=False,
    logfiles={"configure"  : { "filename" : "configure.log", "follow" : True },
              "config.log" : { "filename" : "config.log",    "follow" : True },
              "make"       : { "filename" : "make.log",      "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["building zfs"], descriptionDone=["built zfs"],
    doStepIf = do_step_build_zfs,
    hideStepIf=lambda results, s: results==SKIPPED))

build_factory.addStep(ShellCommand(command=["make", "checkstyle"],
    env={'PATH' : bin_path},
    workdir="build/zfs", logEnviron=False,
    haltOnFailure=False, flunkOnWarnings=True,
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["checking style"], descriptionDone=["checked style"]))

#
# Perform a package build with debugging enabled, install the packages,
# and run of the test suite.  The tests themselves have been seperated from
# the buildbot configuration to minimize the need for restarting the  master.
#
test_factory = util.BuildFactory()

test_factory.addStep(ShellCommand(
    env={'PATH' : bin_path},
    command=["runurl", bb_url + "bb-dependencies.sh"],
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    haltOnFailure=True, logEnviron=False,
    description=["installing dependencies"],
    descriptionDone=["installed dependencies"]))
test_factory.addStep(Git(repourl=spl_repo, workdir="build/spl",
    mode="full", method="clobber", codebase="spl",
    logEnviron=False, getDescription=True,
    description=["cloning"], descriptionDone=["cloned"]))
test_factory.addStep(ShellCommand(
    env={'PATH' : bin_path},
    workdir="build/spl",
    command=["runurl", bb_url + "bb-build-packages.sh"],
    haltOnFailure=True, logEnviron=False,
    logfiles={"configure"  : { "filename" : "configure.log", "follow" : True },
              "config.log" : { "filename" : "config.log",    "follow" : True },
              "make"       : { "filename" : "make.log",      "follow" : True },
              "install"    : { "filename" : "install.log",   "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["building spl"], descriptionDone=["built spl"]))
test_factory.addStep(Git(repourl=zfs_repo, workdir="build/zfs",
    mode="full", method="clobber", codebase="zfs",
    logEnviron=False, getDescription=True,
    description=["cloning"], descriptionDone=["cloned"]))
test_factory.addStep(ShellCommand(
    env={'PATH' : bin_path},
    workdir="build/zfs",
    command=["runurl", bb_url + "bb-build-packages.sh"],
    haltOnFailure=True, logEnviron=False,
    logfiles={"configure"  : { "filename" : "configure.log", "follow" : True },
              "config.log" : { "filename" : "config.log",    "follow" : True },
              "make"       : { "filename" : "make.log",      "follow" : True },
              "install"    : { "filename" : "install.log",   "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["building zfs"], descriptionDone=["built zfs"]))

# Test suites
test_factory.addStep(ShellCommand(
    workdir="build/tests",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-prepare.sh"],
    haltOnFailure=False, maxTime=120, sigtermTime=30, logEnviron=False,
    logfiles={"test"     : { "filename" : "TEST",        "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["preparing env"], descriptionDone=["prepared env"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/splat",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-splat.sh"],
    haltOnFailure=False, maxTime=600, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["splat"], descriptionDone=["splat"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/ztest",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-ztest.sh"],
    haltOnFailure=False, maxTime=14400, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["ztest"], descriptionDone=["ztest"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/ziltest",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-ziltest.sh"],
    haltOnFailure=False, maxTime=120, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["ziltest"], descriptionDone=["ziltest"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/zconfig",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-zconfig.sh"],
    haltOnFailure=False, maxTime=600, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["zconfig"], descriptionDone=["zconfig"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/zimport",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-zimport.sh"],
    haltOnFailure=False, maxTime=1200, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["zimport"], descriptionDone=["zimport"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/filebench",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-filebench.sh"],
    haltOnFailure=False, maxTime=3600, sigtermTime=30, logEnviron=False,
    logfiles={"configure" : { "filename" : "configure.log", "follow" : True },
              "make"      : { "filename" : "make.log",      "follow" : True },
              "console"   : { "filename" : "console.log",   "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["filebench"], descriptionDone=["filebench"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/xfstests",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-xfstests.sh"],
    haltOnFailure=False, maxTime=1200, sigtermTime=30, logEnviron=False,
    logfiles={"configure" : { "filename" : "configure.log", "follow" : True },
              "make"      : { "filename" : "make.log",      "follow" : True },
              "console"   : { "filename" : "console.log",   "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["xfstest"], descriptionDone=["xfstests"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/zfstests",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-zfstests.sh"],
    haltOnFailure=False, maxTime=14400, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False },
              "log"     : { "filename" : "log",         "follow" : True }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["zfstests"], descriptionDone=["zfstests"]))
test_factory.addStep(ShellCommand(
    workdir="build/tests/zfsstress",
    env={'PATH' : bin_path + ":" + zfs_path},
    command=["runurl", bb_url + "bb-test-zfsstress.sh"],
    haltOnFailure=False, maxTime=14400, sigtermTime=30, logEnviron=False,
    logfiles={"console" : { "filename" : "console.log", "follow" : False }},
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["zfsstress"], descriptionDone=["zfsstress"]))

test_factory.addStep(ShellCommand(command=["runurl", bb_url + "bb-cleanup.sh"],
    env={'PATH' : bin_path},
    haltOnFailure=False, logEnviron=False,
    decodeRC={0 : SUCCESS, 1 : FAILURE, 2 : WARNINGS, 3 : SKIPPED },
    description=["removing zfs"], descriptionDone=["removed zfs"]))

####### BUILDERS & BUILDSLAVES
# The 'builders' list defines the Builders, which tell Buildbot how to
# perform a build: what steps, and which slaves can execute them.  Note
# that any particular build will only take place on one slave.

builder_default_properties = {
    "buildlinux":    "no",
    "buildspl":      "yes",
    "buildzfs":      "yes",
    "builtin":       "no",
    "repoowner":     "zfsonlinux",
    "reponame":      "zfs",
}

builder_linux_default_properties = {
    "buildlinux":    "yes",
    "buildspl":      "yes",
    "buildzfs":      "yes",
    "builtin":       "no",
    "repoowner":     "zfsonlinux",
    "reponame":      "zfs",
}

builder_linux_builtin_properties = {
    "buildlinux":    "yes",
    "buildspl":      "no",
    "buildzfs":      "no",
    "builtin":       "yes",
    "repoowner":     "zfsonlinux",
    "reponame":      "zfs",
}

def prioritizeBuilders(buildmaster, builders):
    """
    Called by the buildmaster to prioritize the builders.  Returns a sorted
    array of builders designed to improve ec2 utilization. Builders with
    substantiated, idle slaves are given priority. Followed by builders with no
    substantiated slaves. The lowest priority is a builder that is busy.
    This helps keep all buildslaves busy while new latent buildslaves are 
    bootstrapped, a process which can take several minutes.
    """

    idle_builders = []
    busy_builders = []
    avail_builders = []

    for b in builders:
        idle = False
        busy = False
        for s in b.slaves:
            if s.isIdle():
               idle = True
               break

            if s.isBusy():
               busy = True

        if idle is True:
            if re.search('BUILD', b.name):
                idle_builders.insert(0, b)
            else:
                idle_builders.append(b)
        elif busy is True:
            if re.search('BUILD', b.name):
                busy_builders.insert(0, b)
            else:
                busy_builders.append(b)
        else:
            if re.search('BUILD', b.name):
                avail_builders.insert(0, b)
            else:
                avail_builders.append(b)

    sorted_builders = idle_builders + avail_builders + busy_builders

    log.msg("prioritized %i builder(s): %s" % (len(sorted_builders),
        [b.name for b in sorted_builders]))

    return sorted_builders

c['prioritizeBuilders'] = prioritizeBuilders

build_distro_tags = [ "Distributions" ]
build_arch_tags = [ "Architectures" ]
test_tags = [ "Tests" ]

amazon_x86_64_slaves = [
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave1", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave2", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave3", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave4", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave5", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
    EC2LargeSlaveInfo(
        "Amazon-2015.09-x86_64-buildslave6", "BUILD",
        bb_master, "ami-7238d712", bb_url,
        ec2_default_access, ec2_default_secret, 
        ec2_default_keypair_name),
]

distro_arch_builders = [
    #### Distro builders
    BuilderInfo(
        "Amazon 2015.09 x86_64 (BUILD)", build_factory,
        amazon_x86_64_slaves,
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Kernel.org Default x86_64 (BUILD)", build_factory,
        amazon_x86_64_slaves,
        tags=build_distro_tags,
        properties=builder_linux_default_properties,
    ),
    BuilderInfo(
        "Kernel.org Built-in x86_64 (BUILD)", build_factory,
        amazon_x86_64_slaves,
        tags=build_distro_tags,
        properties=builder_linux_builtin_properties,
    ),
    BuilderInfo(
        "Debian 8 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "Debian-8-x86_64-buildslave1", "BUILD",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "Debian-8-x86_64-buildslave2", "BUILD",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Fedora 23 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "Fedora-23-x86_64-buildslave1", "BUILD",
                bb_master, "ami-750ee115", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "Fedora-23-x86_64-buildslave2", "BUILD",
                bb_master, "ami-750ee115", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "CentOS 6.7 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "CentOS-6.7-x86_64-buildslave1", "BUILD",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "CentOS-6.7-x86_64-buildslave2", "BUILD",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "CentOS 7.1 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "CentOS-7.1-x86_64-buildslave1", "BUILD",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "CentOS-7.1-x86_64-buildslave2", "BUILD",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Ubuntu 12.04 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "Ubuntu-12.04-x86_64-buildslave1", "BUILD",
                bb_master, "ami-0239d662", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "Ubuntu-12.04-x86_64-buildslave2", "BUILD",
                bb_master, "ami-0239d662", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Ubuntu 14.04 x86_64 (BUILD)", build_factory,
        [
            EC2LargeSlaveInfo(
                "Ubuntu-14.04-x86_64-buildslave1", "BUILD",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2LargeSlaveInfo(
                "Ubuntu-14.04-x86_64-buildslave2", "BUILD",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=build_distro_tags,
        properties=builder_default_properties,
    ),
    #### Architecture builders
    BuilderInfo(
        "Ubuntu 14.04 i686 (BUILD)", build_factory,
        [
            PersistSlaveInfo(
                "Ubuntu-14.04-i686-buildslave1",
                slave_userpass["Ubuntu-14.04-i686-buildslave1"]),
            PersistSlaveInfo(
                "Ubuntu-14.04-i686-buildslave2",
                slave_userpass["Ubuntu-14.04-i686-buildslave2"]),
        ],
        tags=build_arch_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Debian 8 arm (BUILD)", build_factory,
        [
            PersistSlaveInfo(
                "Debian-8-arm-buildslave1",
                slave_userpass["Debian-8-arm-buildslave1"]),
            PersistSlaveInfo(
                "Debian-8-arm-buildslave2",
                slave_userpass["Debian-8-arm-buildslave2"]),
        ],
        tags=build_arch_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Debian 8 ppc (BUILD)", build_factory,
        [
            PersistSlaveInfo(
                "Debian-8-ppc-buildslave",
                slave_userpass["Debian-8-ppc-buildslave"]),
        ],
        tags=build_arch_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Debian 8 ppc64 (BUILD)", build_factory,
        [
            PersistSlaveInfo(
                "Debian-8-ppc64-buildslave1",
                slave_userpass["Debian-8-ppc64-buildslave1"]),
            PersistSlaveInfo(
                "Debian-8-ppc64-buildslave2",
                slave_userpass["Debian-8-ppc64-buildslave2"]),
        ],
        tags=build_arch_tags,
        properties=builder_default_properties,
    ),
]

test_builders = [
    #### Test builders
    BuilderInfo(
        "Amazon 2015.09 x86_64 (TEST)", test_factory,
        [
            EC2TestSlaveInfo(
                "Amazon-2015.09-x86_64-testslave1", "TEST",
                bb_master, "ami-7238d712", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Amazon-2015.09-x86_64-testslave2", "TEST",
                bb_master, "ami-7238d712", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Amazon-2015.09-x86_64-testslave3", "TEST",
                bb_master, "ami-7238d712", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Amazon-2015.09-x86_64-testslave4", "TEST",
                bb_master, "ami-7238d712", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Amazon-2015.09-x86_64-testslave5", "TEST",
                bb_master, "ami-7238d712", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=test_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "CentOS 6.7 x86_64 (TEST)", test_factory,
        [
            EC2TestSlaveInfo(
                "CentOS-6.7-x86_64-testslave1", "TEST",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-6.7-x86_64-testslave2", "TEST",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-6.7-x86_64-testslave3", "TEST",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-6.7-x86_64-testslave4", "TEST",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-6.7-x86_64-testslave5", "TEST",
                bb_master, "ami-5139d631", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=test_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "CentOS 7.1 x86_64 (TEST)", test_factory,
        [
            EC2TestSlaveInfo(
                "CentOS-7.1-x86_64-testslave1", "TEST",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-7.1-x86_64-testslave2", "TEST",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-7.1-x86_64-testslave3", "TEST",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-7.1-x86_64-testslave4", "TEST",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "CentOS-7.1-x86_64-testslave5", "TEST",
                bb_master, "ami-4537d825", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=test_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Debian 8 x86_64 (TEST)", test_factory,
        [
            EC2TestSlaveInfo(
                "Debian-8-x86_64-testslave1", "TEST",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Debian-8-x86_64-testslave2", "TEST",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Debian-8-x86_64-testslave3", "TEST",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Debian-8-x86_64-testslave4", "TEST",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Debian-8-x86_64-testslave5", "TEST",
                bb_master, "ami-ef01ee8f", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=test_tags,
        properties=builder_default_properties,
    ),
    BuilderInfo(
        "Ubuntu 14.04 x86_64 (TEST)", test_factory,
        [
            EC2TestSlaveInfo(
                "Ubuntu-14.04-x86_64-testslave1", "TEST",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Ubuntu-14.04-x86_64-testslave2", "TEST",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Ubuntu-14.04-x86_64-testslave3", "TEST",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Ubuntu-14.04-x86_64-testslave4", "TEST",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
            EC2TestSlaveInfo(
                "Ubuntu-14.04-x86_64-testslave5", "TEST",
                bb_master, "ami-550ce335", bb_url,
                ec2_default_access, ec2_default_secret, 
                ec2_default_keypair_name),
        ],
        tags=test_tags,
        properties=builder_default_properties,
    ),
]

all_builders = distro_arch_builders + test_builders

uniqueSlaves = dict()
for builder in all_builders:
    for slave in builder.getSlaves():
        # avoid duplicate slaves because slaves can be part of multiple builders
        if slave.getName() in uniqueSlaves.keys():
            pass
        else:
            uniqueSlaves[slave.getName()] = slave.makeBuildSlave()

c['slaves'] = uniqueSlaves.values()
c['builders'] = [info.getBuilderConfig() for info in all_builders]

# The 'protocols' setting contains information about protocols which master
# will use for communicating with slaves.
c['protocols'] = {'pb': {'port': bb_slave_port}}

####### CHANGESOURCES

# The 'change_source' setting tells the buildmaster how it should find out
# about source code changes.  For this project all notifications occur via
# a Github webhook.  These can be for branch updates or modifications to
# pull requests (open, reopen, synchronize).  A custom pull request handler
# is used to submit changes for every commit which is part of a pull request.

import logging
import urllib2
import json

from buildbot.status.web.hooks.github import GitHubEventHandler
from dateutil.parser import parse as dateparse
from twisted.python import log

def query_url(url, token=None):
    log.msg("Making request to '%s'" % url)
    request = urllib2.Request(url)
    if token:
        request.add_header("Authorization", "token %s" % token)
    response = urllib2.urlopen(request)
    return json.loads(response.read())

def parse_link_header(link_header):
    links = {}
    prog = re.compile('^<([^>]*)>; rel="([^"]*)"$')
    for s in link_header.split(", "):
        m = prog.search(s)
        if m:
            links[m.group(2)] = m.group(1)
        else:
            raise RuntimeError("Could not parse '%s'" % s)
    return links

class CustomGitHubEventHandler(GitHubEventHandler):
    def handle_pull_request(self, payload):
        changes = []
        number = payload['number']
        refname = 'refs/pull/%d/head' % (number,)
        commits_num = payload['pull_request']['commits']
        commits_url = payload['pull_request']['commits_url']
        created_at = dateparse(payload['pull_request']['created_at'])
        commits_cur = 0

        log.msg('Processing GitHub PR #%d' % number, logLevel=logging.DEBUG)

        action = payload.get('action')
        if action not in ('opened', 'reopened', 'synchronize'):
            log.msg("GitHub PR #%d %s, ignoring" % (number, action))
            return changes, 'git'

        commits = query_url(commits_url, token=github_token)

        # Extract any dependency information and translate to a standard form.
        # Requires-spl: refs/pull/PR/head
        spl_pull_request = None
        pattern = '^Requires-spl:\s*([a-zA-Z0-9_\-\:\/\+]+)'
        for commit in commits:
            comments = commit['commit']['message']
            m = re.search(pattern, comments, re.I | re.M)
            if m is not None:
                spl_pull_request = 'Requires-spl: %s' % m.group(1)
                break

        for commit in commits:
            commit = query_url(commit['url'], token=github_token)
            commits_cur += 1

            # Assemble the list of modified files.
            changed_files = []
            for f in commit['files']:
                changed_files.append(f['filename'])

            # Annotate the head commit to allow special handling.
            if commit['sha'] == payload['pull_request']['head']['sha']:
                category = "build,test"
            else:
                category = "build"

            # Annotate every commit with 'Requires-spl' when missing.
            comments = commit['commit']['message'] + "\n\n"
            if spl_pull_request:
                if re.search(pattern, comments, re.I | re.M) is None:
                    comments = comments + spl_pull_request + "\n"

            comments = comments + "Pull-request: #%d part %d/%d\n" % (
                number, commits_cur, commits_num)

            change = {
                'revision' : commit['sha'],
                'when_timestamp': created_at,
                'branch': refname,
                'revlink' : commit['html_url'],
                'repository': payload['repository']['clone_url'],
                'project' : payload['repository']['name'],
                'category': category,
                'author': "%s <%s>" % (commit['commit']['committer']['name'],
                                       commit['commit']['committer']['email']),
                'comments' : comments,
                'files' : changed_files,
            }

            if callable(self._codebase):
                change['codebase'] = self._codebase(payload)
            elif self._codebase is not None:
                change['codebase'] = self._codebase

            changes.append(change)

        log.msg("Received %d changes from GitHub Pull Request #%d" % (
            len(changes), number))
        return changes, 'git'

def codebaseGenerator(chdict):
    return all_repositories[chdict['repository']]

c['codebaseGenerator'] = codebaseGenerator

####### SCHEDULERS

# Configure the Schedulers, which decide how to react to incoming changes.

from buildbot.schedulers.trysched import Try_Userpass
from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.changes.filter import ChangeFilter
from buildbot.changes import filter

build_builders = [info.getName() for info in distro_arch_builders]
test_builders = [info.getName() for info in test_builders]

c['schedulers'] = []

default_codebases = {
    'linux' : {'repository': linux_repo, 'branch': 'master', 'revision': None},
    'spl'   : {'repository': spl_repo, 'branch': 'master', 'revision': None},
    'zfs'   : {'repository': zfs_repo, 'branch': 'master', 'revision': None} }

class CustomSingleBranchScheduler(SingleBranchScheduler):
    spl_pull_request = None

    def gotChange(self, change, important):
        pattern = '^Requires-spl:\s*([a-zA-Z0-9_\-\:\/\+]+)'
        m = re.search(pattern, change.comments, re.I | re.M)
        if m is not None:
            self.spl_pull_request = m.group(1)
        else:
            self.spl_pull_request = None

        return SingleBranchScheduler.gotChange(self, change, important)

    def getCodebaseDict(self, codebase):
        ss = self.codebases[codebase]
        if codebase == "spl":
            if self.spl_pull_request is not None:
                ss['branch'] = self.spl_pull_request

        return ss

# This scheduler is for pull requests.
c['schedulers'].append(CustomSingleBranchScheduler(
    name="pull-request-build-scheduler",
    builderNames=build_builders,
    codebases=default_codebases,
    change_filter=filter.ChangeFilter(category_re=".*build.*")))

# This scheduler is for pull requests.
c['schedulers'].append(CustomSingleBranchScheduler(
    name="pull-request-test-scheduler",
    builderNames=test_builders,
    codebases=default_codebases,
    change_filter=filter.ChangeFilter(category_re=".*test.*")))

# This scheduler is for pushes to branches.
c['schedulers'].append(SingleBranchScheduler(
    name="branch-scheduler",
    builderNames=build_builders + test_builders,
    codebases=default_codebases,
    change_filter=filter.ChangeFilter(project_re=".*/zfs.*")))

# This allows for 'buildbot try' users.
c['schedulers'].append(Try_Userpass(
    name="try-scheduler",
    port=bb_try_port,
    builderNames=build_builders + test_builders,
    userpass=try_userpass))

####### STATUS TARGETS

# 'status' is a list of Status Targets. The results of each build will be
# pushed to these targets. buildbot/status/*.py has a variety to choose from,
# including web pages, email senders, and IRC bots.

c['status'] = []

from buildbot.status import html
from buildbot.status.web import authz, auth
from buildbot.plugins import status, util

authz_cfg=util.Authz(
    auth=util.BasicAuth(web_userpass),
    gracefulShutdown = False,
    pingBuilder = False,
    pauseSlave = 'auth',
    stopBuild = 'auth',
    stopAllBuilds = 'auth',
    forceBuild = 'auth',
    forceAllBuilds = 'auth',
    cancelPendingBuild = 'auth',
)

c['status'].append(html.WebStatus(http_port=bb_web_port,
    order_console_by_time=True, authz=authz_cfg,
    change_hook_dialects={"github" :
        {"secret"   : github_secret,
         "class"    : CustomGitHubEventHandler },
    }))

#
# Used to post builder status updated to Github.
#
repoOwner = util.Interpolate("%(prop:repoowner)s")
repoName = util.Interpolate("%(prop:reponame)s")
sha = util.Interpolate("%(src:zfs:revision)s")
context = util.Interpolate("buildbot/%(prop:buildername)s")
gs = status.GitHubStatus(
    token=github_token,
    repoOwner=repoOwner,
    repoName=repoName,
    sha=sha,
    context=context,
    startDescription='Build started.',
    endDescription='Build done.')

c['status'].append(gs)

####### PROJECT IDENTITY

# the 'title' string will appear at the top of this buildbot
# installation's html.WebStatus home page (linked to the
# 'titleURL') and is embedded in the title of the waterfall HTML page.

c['title'] = "ZFS on Linux"
c['titleURL'] = zol_url

# the 'buildbotURL' string should point to the location where the buildbot's
# internal web server (usually the html.WebStatus page) is visible. This
# typically uses the port number set in the Waterfall 'status' entry, but
# with an externally-visible host name which the buildbot cannot figure out
# without some help.

c['buildbotURL'] = web_url

####### DB URL

c['db'] = {
    # This specifies what database buildbot uses to store its state.  You can
    # leave this at its default for all but the largest installations.
    'db_url' : "sqlite:///state.sqlite",
}
